generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// === ENUMS ===
enum Role {
  GUDANG
  PURCHASING
  MANAJER
}

enum MaterialCategory {
  BAHAN_BAKU
  BAHAN_PENOLONG
}

enum StorageType {
  DRY_STORAGE
  COLD_STORAGE
  LIQUID_STORAGE
  CHEMICAL_STORAGE
  FROZEN_STORAGE
  GENERAL_STORAGE
}

enum RequestStatus {
  PENDING
  PROCESSED
  REJECTED
}

// === MODELS ===

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      Role     @default(GUDANG)
  createdAt DateTime @default(now())
}

model Storage {
  id        String      @id @default(uuid())
  name      String
  type      StorageType @default(GENERAL_STORAGE)
  price     Float       @default(0) // Nilai H (Biaya Simpan per Unit)
  materials Material[]
  transactions Transaction[]
}

model Supplier {
  id             String          @id @default(uuid())
  name           String
  address        String?
  phone          String?
  materials      Material[]
  purchaseOrders PurchaseOrder[]
  orderings      Ordering[]
}

model Material {
  id           String           @id @default(uuid())
  name         String
  unit         String           @default("Kg")
  pricePerUnit Float            @default(0)
  stock        Float            @default(0)
  category     MaterialCategory @default(BAHAN_BAKU)

  // Nilai Default (Backup S & Fixed Cost)
  eoqBiayaPesan    Float @default(0) // S
  existingHoldCost Float @default(0) // Fixed Cost Actual

  // Relasi
  storageId    String?
  storage      Storage?         @relation(fields: [storageId], references: [id])
  supplierId   String?
  supplier     Supplier?        @relation(fields: [supplierId], references: [id])

  orderings    Ordering[]       // History Pesanan (Sumber D & S)
  requestItems RequestItem[]
  orderItems   OrderItem[]
  transactions Transaction[]

  @@index([supplierId])
  @@index([storageId])
}

// Tabel History Pesanan (Sumber Data D & S)
model Ordering {
  id             String   @id @default(uuid())
  materialId     String
  material       Material @relation(fields: [materialId], references: [id])
  supplierId     String?
  supplier       Supplier? @relation(fields: [supplierId], references: [id])
  
  period         String   // "April - September 2025"
  amount         Float    // D (Total Demand)
  price          Float    // Total Biaya Pesan
  frequency      Int      // Freq

  @@index([materialId])
  @@index([supplierId])
}

// === MODUL OPERASIONAL ===

model Transaction {
  id         String    @id @default(uuid())
  createdAt  DateTime  @default(now())
  date       DateTime  @default(now()) // TANGGAL MANUAL
  type       String    // "IN" / "OUT"
  quantity   Float
  note       String?
  
  materialId String
  material   Material  @relation(fields: [materialId], references: [id])
  storageId  String?
  storage    Storage?  @relation(fields: [storageId], references: [id])
  
  @@index([materialId])
  @@index([storageId])
}

model PurchaseRequest {
  id             String          @id @default(uuid())
  code           String          @unique
  createdAt      DateTime        @default(now())
  status         RequestStatus   @default(PENDING)
  note           String?
  items          RequestItem[]
  purchaseOrders PurchaseOrder[]
}

model RequestItem {
  id                String          @id @default(uuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id])
  materialId        String
  material          Material        @relation(fields: [materialId], references: [id])
  quantity          Float
  unit              String?
  @@index([purchaseRequestId])
  @@index([materialId])
}

model PurchaseOrder {
  id                String           @id @default(uuid())
  code              String           @unique
  date              DateTime         @default(now())
  status            String           @default("PENDING")
  totalAmount       Float            @default(0)
  supplierId        String
  supplier          Supplier         @relation(fields: [supplierId], references: [id])
  purchaseRequestId String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id])
  items             OrderItem[]
  @@index([supplierId])
  @@index([purchaseRequestId])
}

model OrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  materialId      String
  material        Material      @relation(fields: [materialId], references: [id])
  quantity        Float
  price           Float
  @@index([purchaseOrderId])
  @@index([materialId])
}