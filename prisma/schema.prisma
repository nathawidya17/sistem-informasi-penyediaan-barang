generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  GUDANG
  PURCHASING
  MANAJER
}

enum MaterialCategory {
  BAHAN_BAKU
  BAHAN_PENOLONG
}

enum StorageType {
  DRY_STORAGE
  COLD_STORAGE
  LIQUID_STORAGE
  CHEMICAL_STORAGE
  FROZEN_STORAGE
  GENERAL_STORAGE
}

// === MODELS ===

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      Role     @default(GUDANG)
  createdAt DateTime @default(now())
}

model Storage {
  id            String      @id @default(uuid())
  name          String
  type          StorageType @default(GENERAL_STORAGE)
  
  // [BARU] Total Biaya Operasional Gudang (Rp)
  // Contoh: Dry Storage = 720.000.000
  operatingCost Float       @default(0) 
  
  materials     Material[]
  transactions  Transaction[]
}

model Supplier {
  id             String          @id @default(uuid())
  name           String
  address        String?
  phone          String?
  materials      Material[]
  purchaseOrders PurchaseOrder[]
  orderings      Ordering[]
}

model Material {
  id           String           @id @default(uuid())
  name         String
  unit         String           @default("Kg")
  pricePerUnit Float            @default(0)
  stock        Float            @default(0)
  category     MaterialCategory @default(BAHAN_BAKU)

  // [BARU] Persentase Alokasi Gudang (0.0 - 1.0)
  // Contoh: 0.45 (45%) untuk Terigu Golden Crown
  storagePercentage Float @default(0) 

  // [DIHAPUS] eoqBiayaPesan (S) -> Akan dihitung dari rata-rata history Ordering
  // [DIHAPUS] biayaPenyimpanan -> Akan dihitung dari (Storage.operatingCost * storagePercentage)

  // Relasi
  storageId    String?
  storage      Storage?         @relation(fields: [storageId], references: [id])
  supplierId   String?
  supplier     Supplier?        @relation(fields: [supplierId], references: [id])

  orderings    Ordering[]       
  requestItems RequestItem[]
  orderItems   OrderItem[]
  transactions Transaction[]

  @@index([supplierId])
  @@index([storageId])
}

// ... Model lainnya (Ordering, Transaction, dll) tetap sama ...
model Ordering {
  id             String   @id @default(uuid())
  materialId     String
  material       Material @relation(fields: [materialId], references: [id])
  supplierId     String?
  supplier       Supplier? @relation(fields: [supplierId], references: [id])
  period         String   
  amount         Float    
  frequency      Int      
  price          Float    // Total Harga Pembelian (Dipakai untuk hitung S)

  @@index([materialId])
  @@index([supplierId])
}

model Transaction {
  id         String    @id @default(uuid())
  createdAt  DateTime  @default(now())
  date       DateTime  @default(now()) 
  type       String    
  quantity   Float
  note       String?
  materialId String
  material   Material  @relation(fields: [materialId], references: [id])
  storageId  String?
  storage    Storage?  @relation(fields: [storageId], references: [id])
  @@index([materialId])
  @@index([storageId])
}

model PurchaseRequest {
  id             String          @id @default(uuid())
  code           String          @unique
  createdAt      DateTime        @default(now())
  status         String          @default("PENDING")
  note           String?
  items          RequestItem[]
  purchaseOrders PurchaseOrder[]
}

model RequestItem {
  id                String          @id @default(uuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id])
  materialId        String
  material          Material        @relation(fields: [materialId], references: [id])
  quantity          Float
  unit              String?
  @@index([purchaseRequestId])
  @@index([materialId])
}

model PurchaseOrder {
  id                String           @id @default(uuid())
  code              String           @unique
  date              DateTime         @default(now())
  status            String           @default("PENDING")
  totalAmount       Float            @default(0)
  supplierId        String
  supplier          Supplier         @relation(fields: [supplierId], references: [id])
  purchaseRequestId String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id])
  items             OrderItem[]
  @@index([supplierId])
  @@index([purchaseRequestId])
}

model OrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  materialId      String
  material        Material      @relation(fields: [materialId], references: [id])
  quantity        Float
  price           Float
  @@index([purchaseOrderId])
  @@index([materialId])
}